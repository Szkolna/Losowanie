<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Losowanie na Mikołajki</title>
    <link rel="stylesheet" href="style.css" type="text/css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.9.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.3/firebase-firestore.js"></script>
</head>
<body>
    <div class="container">
        <h1>Losowanie na Mikołajki</h1>
        <p>Wybierz swoje imię z listy i wciśnij przycisk, aby wylosować osobę na Mikołajki!</p>

        <select id="wybraneImie"></select>
        <button onclick="rozpocznijLosowanie()">Rozpocznij losowanie</button>

        <div id="wynik"></div>

        <div id="resetPanel">
            <h3>Reset losowania</h3>
            <input type="password" id="resetHaslo" placeholder="Wprowadź hasło">
            <button onclick="zresetujLosowanie()">Resetuj losowanie</button>
        </div>
    </div>

    <script>
        // Konfiguracja Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCBk73qxxvTSsGJnGtRra7y6sm7YqrDkok",
            authDomain: "mikolajki-8e3b3.firebaseapp.com",
            projectId: "mikolajki-8e3b3",
            storageBucket: "mikolajki-8e3b3.firebasestorage.app",
            messagingSenderId: "139786940214",
            appId: "1:139786940214:web:b2d1abaf314d7d9cc44d97",
            measurementId: "G-H6QGJ16FPP"
        };
        // Inicjalizacja Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(app);

        // Lista uczestników
        const uczestnicy = [
            'Jan Cuber', 'Oskar Faluszewski', 'Jakub Hemmerling', 'Maciej Iliaszuk', 'Michał Kamiński', 'Oleksandr Kasiian',
            'Jan Kobrzak', 'Tomasz Krasula', 'Mikołaj Leśkiewicz', 'Maciej Majewski', 'Bartosz Pastuszka', 'Jakub Mankiewicz',
            'Wiktor Michalik', 'Jakub Pap', 'Patryk Piesio', 'Julian Witold Szudy', 'Paweł Smogorzewski', 'Tomasz Sajdak',
            'Jakub Woźniak', 'Andrei Svistunovich', 'Daniil Schepelin', 'Vadzim Vait', 'Jan Rozmanowski', 'Stefan Sobkow',
            'Jakub Szulc', 'Milena Zegan', 'Stanislav Priadko', 'Konstantyn Sivak', 'Yegor Tkachenko', 'Wanda Kroplewska'
        ];

        // Funkcja inicjalizująca dane w Firestore
        async function inicjalizujDane() {
            try {
                const snapshot = await db.collection('uczestnicy').get();
                if (snapshot.empty) {
                    const batch = db.batch();
                    uczestnicy.forEach(imie => {
                        const docRef = db.collection('uczestnicy').doc(imie);
                        batch.set(docRef, { wylosowane: null });
                    });
                    await batch.commit();
                    console.log("Dodano uczestników do Firestore");
                }
                pobierzDaneZFirebase();
            } catch (error) {
                console.error("Błąd podczas inicjalizacji danych:", error);
            }
        }

        // Wygeneruj listę imion w <select>
        function wypelnijListeImion(dostepneImiona) {
            const select = document.getElementById('wybraneImie');
            select.innerHTML = ''; // Czyść istniejące opcje
            dostepneImiona.forEach(imie => {
                const opcja = document.createElement('option');
                opcja.value = imie;
                opcja.textContent = imie;
                select.appendChild(opcja);
            });
        }

        // Pobierz dane z Firestore
        async function pobierzDaneZFirebase() {
            try {
                const snapshot = await db.collection('uczestnicy').get();
                const dostepneImiona = uczestnicy.filter(imie => {
                    const doc = snapshot.docs.find(d => d.id === imie);
                    return !(doc && doc.data().wylosowane);
                });
                wypelnijListeImion(dostepneImiona);
            } catch (error) {
                console.error("Błąd podczas pobierania danych z Firebase:", error);
            }
        }

        // Rozpocznij losowanie
        async function rozpocznijLosowanie() {
            const wybraneImie = document.getElementById('wybraneImie').value;
            const snapshot = await db.collection('uczestnicy').get();

            // Sprawdź, czy osoba już losowała
            const doc = snapshot.docs.find(d => d.id === wybraneImie);
            if (doc && doc.data().wylosowane) {
                document.getElementById('wynik').textContent = `Już wylosowano: ${doc.data().wylosowane}`;
                return;
            }

            // Filtruj możliwych do wylosowania uczestników
            const wylosowani = snapshot.docs.map(d => d.data().wylosowane).filter(w => w);
            const pozostaliUczestnicy = uczestnicy.filter(imie => !wylosowani.includes(imie) && imie !== wybraneImie);

            if (pozostaliUczestnicy.length === 0) {
                document.getElementById('wynik').textContent = 'Brak dostępnych osób do wylosowania!';
                return;
            }

            // Wylosuj osobę
            const losowyIndex = Math.floor(Math.random() * pozostaliUczestnicy.length);
            const wylosowaneImie = pozostaliUczestnicy[losowyIndex];

            // Zapisz wynik w Firestore
            await db.collection('uczestnicy').doc(wybraneImie).set({ wylosowane: wylosowaneImie });
            document.getElementById('wynik').textContent = `Wylosowana osoba: ${wylosowaneImie}`;

            // Odśwież listę
            pobierzDaneZFirebase();
        }

        // Zresetuj losowanie
        async function zresetujLosowanie() {
            const haslo = "tajnehaslo";
            const wprowadzoneHaslo = document.getElementById('resetHaslo').value;

            if (wprowadzoneHaslo !== haslo) {
                alert('Niepoprawne hasło!');
                return;
            }

            // Resetuj wszystkie dokumenty w kolekcji `uczestnicy`
            const snapshot = await db.collection('uczestnicy').get();
            const batch = db.batch();
            snapshot.docs.forEach(doc => {
                batch.update(doc.ref, { wylosowane: null });
            });
            await batch.commit();

            alert('Losowanie zostało zresetowane.');
            pobierzDaneZFirebase();
        }

        // Inicjalizuj dane na stronie
        inicjalizujDane();
    </script>
</body>
</html>
